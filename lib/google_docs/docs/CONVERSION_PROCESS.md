# Google Docs Conversion Process

**Version**: 1.0.0
**Last Updated**: 2026-01-23

---

## 개요

마크다운 문서를 Google Docs로 변환하는 전체 프로세스 설계 문서입니다.

---

## 1. 아키텍처 개요

```
┌─────────────────────────────────────────────────────────────────────┐
│                        Google Docs Converter                        │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────────────────┐  │
│  │   CLI       │    │  Python API │    │  Auto Trigger           │  │
│  │ __main__.py │    │  converter  │    │  auto_trigger.py        │  │
│  └──────┬──────┘    └──────┬──────┘    └───────────┬─────────────┘  │
│         │                  │                       │                │
│         └──────────────────┼───────────────────────┘                │
│                            ▼                                        │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │                    Core Engine                               │    │
│  │  ┌─────────────────────────────────────────────────────┐    │    │
│  │  │           MarkdownToDocsConverter                    │    │    │
│  │  │  • _preprocess_content() - 전처리                   │    │    │
│  │  │  • parse() - 마크다운 파싱                          │    │    │
│  │  │  • create_google_doc() - 문서 생성                  │    │    │
│  │  └─────────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────────┘    │
│                            │                                        │
│         ┌──────────────────┼──────────────────┐                     │
│         ▼                  ▼                  ▼                     │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐              │
│  │ TableRender │    │ NotionStyle │    │ ImageInsert │              │
│  │ 테이블 처리 │    │ 스타일 적용 │    │ 이미지 삽입 │              │
│  └─────────────┘    └─────────────┘    └─────────────┘              │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
                            │
                            ▼
              ┌─────────────────────────────┐
              │     Google APIs             │
              │  • Docs API (문서 생성)     │
              │  • Drive API (폴더, 이미지) │
              └─────────────────────────────┘
```

---

## 2. 변환 프로세스 (6단계)

### 전체 흐름

```
입력 (Markdown)
    │
    ▼
┌───────────────────────────────────────────────────────────────┐
│ Stage 1: 전처리 (Preprocessing)                               │
│   • YAML Frontmatter 제거                                     │
│   • 참조 링크 추출                                             │
│   • 각주 제거                                                  │
│   • 괄호 안 영문 표기 삭제                                     │
│   • HTML 원본 링크 삭제                                        │
└───────────────────────────────────────────────────────────────┘
    │
    ▼
┌───────────────────────────────────────────────────────────────┐
│ Stage 2: 파싱 (Parsing)                                        │
│   • 라인별 마크다운 요소 식별                                  │
│   • 인라인 포맷팅 파싱 (Bold, Italic, Code, Link, Image)      │
│   • Google Docs API 요청 생성                                  │
└───────────────────────────────────────────────────────────────┘
    │
    ▼
┌───────────────────────────────────────────────────────────────┐
│ Stage 3: 문서 생성 (Document Creation)                         │
│   • 빈 Google Docs 문서 생성                                   │
│   • 지정 폴더로 이동                                           │
│   • 페이지 스타일 적용 (A4, 72pt 여백)                         │
└───────────────────────────────────────────────────────────────┘
    │
    ▼
┌───────────────────────────────────────────────────────────────┐
│ Stage 4: 콘텐츠 삽입 (Content Insertion)                       │
│   • 텍스트, 제목, 리스트 삽입                                  │
│   • 테이블 2단계 처리 (구조 → 콘텐츠)                          │
│   • 코드 블록 스타일링                                         │
└───────────────────────────────────────────────────────────────┘
    │
    ▼
┌───────────────────────────────────────────────────────────────┐
│ Stage 5: 이미지 처리 (Image Processing)                        │
│   • 로컬 이미지 → Drive 업로드                                 │
│   • Placeholder → 실제 이미지 교체                             │
│   • 역순 처리 (인덱스 시프트 방지)                             │
└───────────────────────────────────────────────────────────────┘
    │
    ▼
┌───────────────────────────────────────────────────────────────┐
│ Stage 6: 마무리 (Finalization)                                 │
│   • 전체 문서 줄간격 적용 (115%)                               │
│   • 문서 URL 반환                                              │
└───────────────────────────────────────────────────────────────┘
    │
    ▼
출력 (Google Docs URL)
```

---

## 3. Stage 1: 전처리 (Preprocessing)

### 3.1 처리 순서

| 순서 | 처리 | 정규식/패턴 | 예시 |
|:----:|------|-------------|------|
| 1 | YAML Frontmatter 제거 | `---` ... `---` | 문서 메타데이터 |
| 2 | 참조 링크 추출 | `[ref]: url` | `[github]: https://...` |
| 3 | 각주 제거 | `[^N]: note` | `[^1]: 참고사항` |
| 4 | 괄호 안 영문 삭제 | `(?<=[가-힣0-9])\s*\([A-Za-z...]+\)` | `3대 원천 (Three Pillars)` → `3대 원천` |
| 5 | HTML 원본 링크 삭제 | `\[HTML\s*원본\]\([^)]+\)` | `[HTML 원본](./mockups/...)` → 삭제 |

### 3.2 구현 위치

```
converter.py:94-159
└── _preprocess_content()
    ├── YAML 제거 (105-110)
    ├── 참조 링크 추출 (116-123)
    ├── 각주 제거 (125-131)
    ├── 괄호 영문 삭제 (141-145)
    └── HTML 원본 삭제 (150-159)
```

### 3.3 확장 포인트

새 전처리 규칙 추가 시:

```python
# converter.py _preprocess_content() 끝에 추가
# N. 새 전처리 규칙
self.content = re.sub(
    r'패턴',
    '대체값',
    self.content
)
```

---

## 4. Stage 2: 파싱 (Parsing)

### 4.1 지원 마크다운 요소

| 요소 | 패턴 | Google Docs 변환 |
|------|------|------------------|
| 제목 (H1-H6) | `# ~ ######` | TITLE, HEADING_1-6 |
| 볼드 | `**text**`, `__text__` | Bold 스타일 |
| 이탤릭 | `*text*`, `_text_` | Italic 스타일 |
| 볼드+이탤릭 | `***text***` | Bold + Italic |
| 인라인 코드 | `` `code` `` | Consolas 폰트 + 배경색 |
| 코드 블록 | ` ``` ` ... ` ``` ` | 코드 블록 스타일 |
| 링크 | `[text](url)` | 하이퍼링크 |
| 이미지 | `![alt](url)` | 인라인 이미지 |
| 테이블 | `\| col \| col \|` | 네이티브 테이블 |
| 불릿 리스트 | `- item`, `* item` | 불릿 리스트 |
| 체크리스트 | `- [ ]`, `- [x]` | 체크박스 |
| 인용문 | `> text` | 인용문 스타일 |
| 수평선 | `---`, `***` | 하단 구분선 |
| 취소선 | `~~text~~` | Strikethrough |

### 4.2 인라인 포맷팅 우선순위

```python
patterns = [
    ("image", r"!\[([^\]]*)\]\(([^)]+)\)"),      # 이미지 (최우선)
    ("link", r"\[([^\]]+)\]\(([^)]+)\)"),         # 링크
    ("bold_italic", r"\*\*\*(.+?)\*\*\*"),        # 볼드+이탤릭
    ("bold", r"\*\*(.+?)\*\*"),                   # 볼드
    ("italic", r"(?<!\*)\*(?!\*)(.+?)(?<!\*)\*(?!\*)"),  # 이탤릭
    ("code", r"`([^`]+)`"),                       # 인라인 코드
    ("strikethrough", r"~~(.+?)~~"),              # 취소선
]
```

### 4.3 깨진 링크 필터링

Google Docs에서 작동하지 않는 링크 자동 제외:

| 제외 패턴 | 예시 | 이유 |
|-----------|------|------|
| 앵커 링크 | `#section` | 내부 참조 불가 |
| 파일 프로토콜 | `file://...` | 보안 제한 |
| 상대 경로 | `./`, `../` | 경로 해석 불가 |
| 로컬 HTML | `.html`, `.htm` | 브라우저 전용 |
| 로컬 마크다운 | `.md` | 미지원 |

---

## 5. Stage 3-4: 문서 생성 및 콘텐츠 삽입

### 5.1 API 호출 최적화

| 작업 | API 호출 | 횟수 |
|------|----------|:----:|
| 문서 생성 | `documents.create` | 1 |
| 폴더 이동 | `drive.files.update` | 1 |
| 페이지 스타일 | `documents.batchUpdate` | 1 |
| 콘텐츠 삽입 | `documents.batchUpdate` | 가변 |
| 테이블 구조 | `documents.batchUpdate` | 테이블당 1 |
| 인덱스 조회 | `documents.get` | 2+ |

### 5.2 테이블 2단계 처리

```
Stage 1: 테이블 구조 생성
    │
    ├─ insertTable 요청
    │
    ▼
documents.batchUpdate 실행
    │
    ▼
Stage 2: 문서 재조회
    │
    ├─ documents.get (테이블 인덱스 확인)
    │
    ▼
Stage 3: 콘텐츠/스타일 삽입
    │
    ├─ 셀 텍스트 삽입 (역순)
    ├─ 헤더 배경색
    ├─ 테두리 스타일
    │
    ▼
documents.batchUpdate 실행
```

### 5.3 Rate Limit (429) 처리

```python
def _execute_with_retry(request_fn, max_retries=5, initial_delay=30):
    for attempt in range(max_retries):
        try:
            return request_fn()
        except HttpError as e:
            if e.resp.status == 429:
                wait_time = initial_delay * (1.5 ** attempt)
                time.sleep(wait_time)
            else:
                raise
```

| 재시도 | 대기 시간 |
|:------:|:---------:|
| 1 | 30초 |
| 2 | 45초 |
| 3 | 67초 |
| 4 | 101초 |
| 5 | 152초 |

---

## 6. Stage 5: 이미지 처리

### 6.1 4단계 이미지 처리 흐름

```
마크다운 이미지
    │
    ▼
┌────────────────────────────────────────┐
│ Phase 1: Placeholder 삽입               │
│   ![alt](path) → [🖼 alt]              │
└────────────────────────────────────────┘
    │
    ▼
┌────────────────────────────────────────┐
│ Phase 2: 로컬 이미지 업로드             │
│   로컬 경로 → Drive 업로드 → 공개 URL  │
└────────────────────────────────────────┘
    │
    ▼
┌────────────────────────────────────────┐
│ Phase 3: Placeholder 위치 파악          │
│   documents.get (1회) → 모든 위치 수집  │
└────────────────────────────────────────┘
    │
    ▼
┌────────────────────────────────────────┐
│ Phase 4: 삭제 + 삽입 (역순)             │
│   deleteContentRange + insertInlineImage│
│   (인덱스 시프트 방지)                  │
└────────────────────────────────────────┘
```

### 6.2 이미지 경로 정규화

| 입력 | 처리 | 결과 |
|------|------|------|
| `https://...` | 그대로 사용 | HTTP URL |
| `./images/a.png` | base_path 기준 해석 | 절대 경로 |
| `../images/b.png` | base_path 기준 해석 | 절대 경로 |
| `C:\...\c.png` | 그대로 사용 | 절대 경로 |
| `data:image/...` | 그대로 사용 | Data URL |

---

## 7. Stage 6: 마무리

### 7.1 최종 스타일 적용

```python
# 전체 문서 줄간격 115%
{
    "updateParagraphStyle": {
        "range": {"startIndex": 1, "endIndex": end_index - 1},
        "paragraphStyle": {"lineSpacing": 115},
        "fields": "lineSpacing"
    }
}
```

### 7.2 문서 URL 형식

```
https://docs.google.com/document/d/{DOCUMENT_ID}/edit
```

---

## 8. 스타일 시스템

### 8.1 색상 팔레트

| 용도 | 색상 | Hex |
|------|------|-----|
| 본문 텍스트 | 진한 회색 | `#404040` |
| 제목 (H1) | 진한 파랑 | `#1A4D8C` |
| 제목 (H2) | 중간 파랑 | `#3373B3` |
| 제목 (H3+) | 진한 회색 | `#404040` |
| 코드 배경 | 연한 회색 | `#F2F2F2` |
| 테이블 헤더 | 연한 회색 | `#E6E6E6` |
| 테이블 테두리 | 회색 | `#CCCCCC` |
| 링크 | 파랑 | `#0F75E0` |

### 8.2 타이포그래피

| 요소 | 폰트 | 크기 | 줄간격 |
|------|------|:----:|:------:|
| Title | Noto Sans KR | 24pt | 130% |
| H1 | Noto Sans KR | 20pt | 130% |
| H2 | Noto Sans KR | 16pt | 130% |
| H3 | Noto Sans KR | 14pt | 130% |
| Body | Noto Sans KR | 11pt | 165% |
| Code | Consolas | 11pt | 140% |

### 8.3 페이지 설정

| 항목 | 값 |
|------|-----|
| 용지 크기 | A4 (595.28 x 841.89 pt) |
| 여백 | 72pt (1 inch) |
| 줄간격 | 115% |

---

## 9. 에러 처리

### 9.1 에러 유형별 처리

| 에러 | 처리 방법 |
|------|----------|
| Rate Limit (429) | 지수 백오프 재시도 |
| 인증 실패 | 토큰 갱신 후 재시도 |
| 이미지 로드 실패 | **조용히 스킵** (문서 독립성 보장) |
| 깨진 링크 | 자동 필터링 |
| 테이블 인덱스 오류 | 2단계 처리로 회피 |

> **설계 원칙**: 유효하지 않은 이미지나 링크는 경고 메시지 대신 완전히 삭제하여
> Google Docs 문서가 독립적으로 완성됩니다.

### 9.2 로그 메시지

```
[OK] 문서 생성됨: {title}
     ID: {document_id}
     폴더로 이동됨
     페이지 스타일 적용됨 (A4, 72pt 여백)
     콘텐츠 추가됨: {N} 요청
     로컬 이미지 {N}개 업로드됨
     이미지 {N}개 삽입됨
     줄간격 적용됨 (115%)
[OK] {document_url}
```

---

## 10. 사용법

### 10.1 CLI

```bash
# 단일 파일 변환
python -m lib.google_docs convert "C:\path\to\file.md"

# 제목 지정
python -m lib.google_docs convert "file.md" --title "문서 제목"

# 폴더 지정
python -m lib.google_docs convert "file.md" --folder "FOLDER_ID"

# 배치 변환
python -m lib.google_docs batch "C:\path\to\*.md"
```

### 10.2 Python API

```python
from lib.google_docs import create_google_doc

url = create_google_doc(
    title="문서 제목",
    content=markdown_content,
    folder_id=None,  # 기본 폴더 사용
    include_toc=False,
    use_native_tables=True,
    base_path="C:/path/to/markdown/file.md"  # 이미지 상대 경로 기준
)
```

### 10.3 서브 프로젝트에서 사용

```bash
# 반드시 루트에서 실행
cd C:\claude && python -m lib.google_docs convert "C:\claude\project\docs\file.md"
```

---

## 11. 확장 가이드

### 11.1 새 전처리 규칙 추가

```python
# converter.py _preprocess_content() 끝에 추가
# N. 새 전처리 규칙 설명
self.content = re.sub(r'패턴', '대체값', self.content)
```

### 11.2 새 마크다운 요소 지원

```python
# converter.py parse() 내 while 루프에 추가
if line.strip().startswith("새패턴"):
    self._add_new_element(line)
    i += 1
    continue
```

### 11.3 새 스타일 추가

```python
# notion_style.py NotionStyle 클래스에 추가
"new_style": {
    "size": 12,
    "color": "text_primary",
    "weight": 400,
}
```

---

*Last Updated: 2026-01-23*
