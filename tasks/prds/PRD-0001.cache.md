<!--
  PRD-0001 Local Cache (Read-Only)
  Master: https://docs.google.com/document/d/1r84LOk6MZUXeTVhAmKimnnJWyxvZGzQJfMZf972SRtw/edit
  Last Synced: 2025-12-23T23:51:36.860662Z
  DO NOT EDIT - Changes will be overwritten
-->


---

# PRD-0001: 포커 핸드 자동 캡처 및 분류 시스템

## 문서 정보

| 항목 | 내용 |

|------|------|

| **PRD ID** | PRD-0001 |

| **제목** | 포커 피처 테이블 핸드 자동 캡처 및 분류 시스템 |

| **버전** | 1.0 |

| **작성일** | 2025-12-23 |

| **상태** | Draft |

---

## 1. 개요

### 1.1 배경

PokerGFX.io 솔루션을 사용하는 포커 프로덕션 환경에서 여러 대의 피처 테이블(3-5대)에서 발생하는 핸드를 자동으로 캡처하고 분류하는 시스템이 필요합니다. 현재는 수동으로 핸드를 모니터링하고 하이라이트를 선별해야 하며, 이는 비효율적이고 중요한 핸드를 놓칠 위험이 있습니다.

### 1.2 목표

1. **핸드 시작/종료 자동 감지**: 각 테이블에서 핸드의 시작점과 종료점을 정확하게 포착

2. **핸드 등급 자동 분류**: 족보(Royal Flush ~ High Card)에 따른 자동 분류

3. **2중 안정성 확보**: Primary(PokerGFX JSON API) + Secondary(AI Video) 이중화 아키텍처

4. **실시간 오버레이 및 통계 저장**: 방송용 오버레이와 Hand2Note 연동

### 1.3 성공 지표

| 지표 | 목표값 |

|------|--------|

| 핸드 감지 정확도 | > 99% (Primary 사용 시) |

| 핸드 분류 정확도 | 100% (phevaluator 기반) |

| 시스템 가용성 | > 99.9% (이중화 적용) |

| 핸드 감지 지연시간 | < 2초 |

---

## 2. 사용자 환경

### 2.1 현재 인프라

| 항목 | 현황 |

|------|------|

| **PokerGFX 라이선스** | 엔터프라이즈/프로 |

| **피처 테이블 수** | 3-5대 동시 운영 |

| **영상 워크플로우** | 실시간 후반 편집 → 방송 송출 |

### 2.2 활용 목적

- 통계/분석 저장 (Hand2Note 연동)

- 실시간 스트리밍 오버레이 (핸드 등급 표시)

- 하이라이트 클립 자동 마킹 (후반 편집용)

---

## 3. 기술 아키텍처

### 3.1 2중 안정성 아키텍처

```

┌─────────────────────────────────────────────────────────────────────────────┐

│                    DUAL-REDUNDANCY ARCHITECTURE                             │

├─────────────────────────────────────────────────────────────────────────────┤

│                                                                              │

│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │

│  │   Table 1    │  │   Table 2    │  │   Table 3    │  │   Table 4    │   │

│  │  (PokerGFX)  │  │  (PokerGFX)  │  │  (PokerGFX)  │  │  (PokerGFX)  │   │

│  │  + Camera    │  │  + Camera    │  │  + Camera    │  │  + Camera    │   │

│  └───────┬──────┘  └───────┬──────┘  └───────┬──────┘  └───────┬──────┘   │

│          │                 │                 │                 │          │

│          ▼                 ▼                 ▼                 ▼          │

│  ┌─────────────────────────────────────────────────────────────────────┐  │

│  │                     INPUT LAYER (Per Table)                         │  │

│  │  ┌─────────────────────────┐  ┌─────────────────────────┐          │  │

│  │  │  PRIMARY: PokerGFX API  │  │  SECONDARY: Video Feed  │          │  │

│  │  │  - JSON Hand Events     │  │  - RTSP/NDI Stream      │          │  │

│  │  │  - RFID Card Data       │  │  - 1080p/4K Input       │          │  │

│  │  └────────────┬────────────┘  └────────────┬────────────┘          │  │

│  └───────────────┼────────────────────────────┼────────────────────────┘  │

│                  │                            │                           │

│                  ▼                            ▼                           │

│  ┌─────────────────────────────────────────────────────────────────────┐  │

│  │                    PROCESSING LAYER                                  │  │

│  │  ┌──────────────────────┐    ┌──────────────────────┐              │  │

│  │  │  PRIMARY PROCESSOR   │    │ SECONDARY PROCESSOR  │              │  │

│  │  │  - JSON Parser       │    │ - Gemini Live API    │              │  │

│  │  │  - phevaluator       │    │ - AI Inference       │              │  │

│  │  └──────────┬───────────┘    └──────────┬───────────┘              │  │

│  │             │                           │                          │  │

│  │             └─────────────┬─────────────┘                          │  │

│  │                           ▼                                         │  │

│  │             ┌──────────────────────────┐                           │  │

│  │             │    FUSION ENGINE         │                           │  │

│  │             │    - Cross-Validation    │                           │  │

│  │             │    - Failover Logic      │                           │  │

│  │             └────────────┬─────────────┘                           │  │

│  └──────────────────────────┼──────────────────────────────────────────┘  │

│                             │                                             │

│                             ▼                                             │

│  ┌─────────────────────────────────────────────────────────────────────┐  │

│  │                      OUTPUT LAYER                                    │  │

│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐   │  │

│  │  │ Hand2Note  │  │ Real-time  │  │ Clip       │  │ Dashboard  │   │  │

│  │  │ Statistics │  │ Overlay    │  │ Markers    │  │ Monitor    │   │  │

│  │  └────────────┘  └────────────┘  └────────────┘  └────────────┘   │  │

│  └─────────────────────────────────────────────────────────────────────┘  │

└─────────────────────────────────────────────────────────────────────────────┘

```

### 3.2 Layer 1: Primary (PokerGFX JSON API)

#### 역할

- **신뢰도**: 99.9% (RFID 기반 정확한 데이터)

- **지연시간**: < 100ms

- **용도**: 핸드 데이터의 정확한 소스

#### PokerGFX JSON 출력 구조 (예상)

```json

{

  "event": "hand_complete",

  "table_id": "feature_table_1",

  "hand_number": 12345,

  "timestamp": "2025-01-15T14:30:00.000Z",

  "players": [

    {

      "seat": 1,

      "name": "Player A",

      "hole_cards": ["Ah", "Kd"],

      "stack": 50000

    },

    {

      "seat": 3,

      "name": "Player B",

      "hole_cards": ["Qs", "Qc"],

      "stack": 45000

    }

  ],

  "community_cards": ["Qs", "Jc", "10h", "2d", "5s"],

  "actions": [

    {"player": "Player A", "action": "raise", "amount": 1000, "street": "preflop"},

    {"player": "Player B", "action": "call", "amount": 1000, "street": "preflop"}

  ],

  "pot": 25000,

  "winner": "Player A",

  "showdown": true

}

```

#### 핸드 분류 엔진 (phevaluator)

```python

from phevaluator import evaluate_cards

class PokerGFXProcessor:

    """PokerGFX JSON 데이터 기반 핸드 분류 엔진"""

    RANK_NAMES = {

        1: "Royal Flush", 2: "Straight Flush", 3: "Four of a Kind",

        4: "Full House", 5: "Flush", 6: "Straight",

        7: "Three of a Kind", 8: "Two Pair", 9: "One Pair", 10: "High Card"

    }

    def process_hand_event(self, json_data: dict) -> HandResult:

        """PokerGFX JSON 이벤트 처리 및 핸드 분류"""

        best_hands = []

        for player in json_data.get('players', []):

            if player.get('hole_cards'):

                all_cards = player['hole_cards'] + json_data['community_cards']

                rank = evaluate_cards(*self._convert_cards(all_cards))

                best_hands.append({

                    'player': player['name'],

                    'rank_value': rank,

                    'rank_name': self._get_rank_category(rank)

                })

        # 최고 핸드 결정 및 결과 반환

        ...

```

### 3.3 Layer 2: Secondary (AI Video 분석)

#### 역할

- **신뢰도**: 85-95% (조명, 각도에 따라 변동)

- **지연시간**: 1-3초 (1 FPS 샘플링)

- **용도**: Primary 백업 + 맥락적 이벤트 감지

#### AI 모델 선택

| 용도 | 모델 | 이유 |

|------|------|------|

| **실시간 비디오 분석** | Gemini 2.5 Flash Native Audio (Live API) | WebSocket 실시간 스트리밍 지원 |

| **녹화 비디오 분석** | Gemini 3 Flash | 더 높은 정확도, 최대 45분 비디오 |

> **참고**: Gemini 3 Flash (2025년 12월 출시)는 Live API를 지원하지 않음. 실시간 분석에는 Gemini 2.5 Flash Native Audio 사용 필요.

#### Gemini Live API 구현

```python

class GeminiLiveProcessor:

    """Gemini Live API 기반 실시간 비디오 분석"""

    GEMINI_WS_URL = "wss://generativelanguage.googleapis.com/ws/..."

    SYSTEM_PROMPT = """

    You are a poker broadcast analyzer. Detect:

    1. Hand boundaries (start/end)

    2. Card detection (community & hole cards)

    3. Action detection (all-in, showdown)

    4. Hand ranking

    Respond in JSON format:

    {

      "event": "hand_start|hand_end|showdown|all_in",

      "cards_detected": ["Ah", "Kd"],

      "hand_rank": "Full House",

      "confidence": 0.95

    }

    """

    async def process_video_stream(self, rtsp_url: str):

        """RTSP 스트림 1 FPS 처리"""

        ...

```

### 3.4 Fusion Engine: 2중 검증 로직

```

┌─────────────────────────────────────────────────────────────────┐

│                    DECISION MATRIX                              │

├─────────────────────────────────────────────────────────────────┤

│                                                                  │

│  Case 1: Primary Available + Secondary Matches                   │

│  ➜ Use Primary, log cross-validation success                     │

│                                                                  │

│  Case 2: Primary Available + Secondary Differs                   │

│  ➜ Use Primary, flag for manual review                          │

│                                                                  │

│  Case 3: Primary Unavailable + Secondary Available               │

│  ➜ Use Secondary with confidence threshold (>0.8)               │

│                                                                  │

│  Case 4: Both Unavailable                                        │

│  ➜ Mark as "Undetected", require manual input                   │

│                                                                  │

└─────────────────────────────────────────────────────────────────┘

```

---

## 4. 기능 요구사항

### 4.1 핵심 기능

| ID | 기능 | 우선순위 | 설명 |

|----|------|----------|------|

| F-001 | 핸드 시작 감지 | P0 | 새 핸드 딜링 시점 자동 감지 |

| F-002 | 핸드 종료 감지 | P0 | 팟 푸시, 카드 머크 시점 감지 |

| F-003 | 핸드 등급 분류 | P0 | 족보 자동 분류 (10단계) |

| F-004 | 멀티테이블 동시 처리 | P0 | 3-5대 테이블 병렬 처리 |

| F-005 | 2중 검증 | P1 | Primary-Secondary 교차 검증 |

| F-006 | Hand2Note 연동 | P1 | 핸드 히스토리 자동 전송 |

| F-007 | 실시간 오버레이 | P1 | WebSocket 기반 방송 오버레이 |

| F-008 | 클립 마커 생성 | P2 | EDL/XML 편집점 자동 생성 |

| F-009 | 모니터링 대시보드 | P2 | 시스템 상태 실시간 모니터링 |

### 4.2 핸드 등급 분류 기준

| 등급 | 핸드 | 프리미엄 여부 |

|------|------|-------------|

| 1 | Royal Flush | ✅ |

| 2 | Straight Flush | ✅ |

| 3 | Four of a Kind | ✅ |

| 4 | Full House | ✅ |

| 5 | Flush | ❌ |

| 6 | Straight | ❌ |

| 7 | Three of a Kind | ❌ |

| 8 | Two Pair | ❌ |

| 9 | One Pair | ❌ |

| 10 | High Card | ❌ |

> 프리미엄 핸드(등급 1-4)는 자동으로 하이라이트 마킹

---

## 5. 기술 스택

### 5.1 컴포넌트별 기술

| Layer | 컴포넌트 | 기술 | 비고 |

|-------|----------|------|------|

| Primary | PokerGFX JSON | 기존 라이선스 | API 문서 필요 |

| Primary | Hand Evaluator | phevaluator (Python) | 무료, 최고 성능 |

| Secondary | AI Video | Gemini 2.5 Flash Live API | WebSocket |

| Secondary | Video Capture | OpenCV + FFmpeg | RTSP/NDI 입력 |

| Fusion | Engine | Python 3.11+ | 비동기 처리 |

| Output | Statistics | Hand2Note API | $8/월 |

| Output | Overlay | WebSocket + HTML | 브라우저 소스 |

| Output | Markers | EDL/XML | Premiere/DaVinci 호환 |

| Infra | Server | GPU (RTX 3060+) | AI 추론용 |

### 5.2 예상 비용

| 항목 | 초기 비용 | 월 운영 비용 |

|------|----------|-------------|

| PokerGFX 라이선스 | (기존) | - |

| Gemini API | - | $50-200 |

| Hand2Note Pro | - | $8 |

| 서버 (GPU) | $1,500~ | 전기료 |

| **합계** | $1,500~ | **$60-210** |

---

## 6. 구현 로드맵

### Phase 1: Primary 구축 (Week 1-2)

- [ ] PokerGFX API 문서 확보

- [ ] JSON 형식 분석 및 파서 개발

- [ ] phevaluator 기반 핸드 분류 엔진

- [ ] 단일 테이블 테스트

### Phase 2: Secondary 구축 (Week 3-4)

- [ ] Gemini Live API 계정 설정

- [ ] 비디오 스트림 캡처 파이프라인

- [ ] 포커 컨텍스트 프롬프트 튜닝

- [ ] 단일 테이블 AI 분석 테스트

### Phase 3: Fusion 통합 (Week 5)

- [ ] Fusion Engine 개발

- [ ] 교차 검증 로직 구현

- [ ] 모니터링 대시보드 구축

### Phase 4: 멀티테이블 확장 (Week 6-7)

- [ ] 3-5대 테이블 동시 처리

- [ ] 부하 테스트 및 최적화

- [ ] Hand2Note 연동

- [ ] 실시간 오버레이 개발

### Phase 5: 프로덕션 배포 (Week 8)

- [ ] 실제 방송 환경 테스트

- [ ] 모니터링 및 알림 설정

- [ ] 운영 매뉴얼 작성

- [ ] 후반 편집 워크플로우 연동

---

## 7. 위험 요소 및 대응

| 위험 | 영향 | 대응 방안 |

|------|------|----------|

| PokerGFX API 미제공 | 높음 | AI Video를 Primary로 승격, YOLO 커스텀 모델 |

| Gemini API 비용 초과 | 중간 | 프레임 레이트 조정 (0.5 FPS), 배치 처리 |

| 네트워크 지연 | 중간 | 로컬 버퍼링, 오프라인 모드 |

| AI 오탐지 | 낮음 | 신뢰도 임계값 조정, 수동 검토 플래그 |

---

## 8. 다음 단계 (액션 아이템)

### 즉시 필요

1. **PokerGFX 기술지원 연락**

   - JSON API 문서 요청

   - 멀티테이블 이벤트 스트림 구조 확인

2. **Gemini API 키 발급**

   - Google AI Studio 또는 Vertex AI

   - Live API 접근 권한 확인

### 기술 검증

3. **PoC 개발**

   - 단일 테이블 Primary 파이프라인

   - Gemini Live API 연동 테스트

4. **비디오 인프라 확인**

   - 각 테이블 카메라의 RTSP/NDI 출력 가능 여부

   - 네트워크 대역폭 (테이블당 5-10 Mbps)

---

## 부록

### A. 참조 자료

- [PokerGFX 공식](https://www.pokergfx.io/)

- [Gemini Live API](https://ai.google.dev/gemini-api/docs/live)

- [Gemini 3 Flash](https://blog.google/products/gemini/gemini-3-flash/)

- [phevaluator](https://github.com/HenryRLee/PokerHandEvaluator)

- [Hand2Note API](https://github.com/hand2note/Hand2NoteApi)

### B. 용어 정의

| 용어 | 설명 |

|------|------|

| RFID | Radio-Frequency Identification, 카드 인식 기술 |

| Hand | 포커에서 딜링부터 팟 푸시까지의 한 라운드 |

| Showdown | 남은 플레이어들이 카드를 공개하는 시점 |

| Hole Cards | 플레이어에게만 보이는 두 장의 카드 |

| Community Cards | 테이블 중앙에 공개되는 5장의 카드 |

| EDL | Edit Decision List, 비선형 편집 마커 형식 |
