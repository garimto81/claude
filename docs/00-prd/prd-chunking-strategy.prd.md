# PRD: PRD/기획서 전용 Chunking 전략

**버전**: 1.0.0 | **작성일**: 2026-02-19 | **작성자**: Claude

---

## 1. 배경 및 목적

### 1.1 배경

Claude Code에서 MD 파일 또는 PDF를 읽을 때 토큰값 초과 오류가 발생하는 현상이 보고되었다. Claude API의 컨텍스트 윈도우 한계(입력 토큰 기준 약 90,000~150,000 토큰 구간에서 실제 오류 발생)로 인해, 대형 문서를 단일 요청으로 처리하는 방식은 근본적으로 한계가 있다.

특히 PRD(Product Requirements Document, 제품 요구사항 문서)나 기획서는 구조적 특성이 명확하여 — 섹션/소섹션/표/목록/다이어그램 등의 계층적 구성 — 일반적인 Fixed-size 청킹보다 문서 구조를 인식하는 지능형 청킹 전략이 훨씬 효과적이다.

현재 `/chunk` 커맨드는 기본 4,000 토큰 / 200 토큰 오버랩의 단순 Fixed-size 방식만 지원하며, PRD 문서의 계층 구조나 의미론적 경계를 고려하지 않는다. 이를 개선하여 PRD 및 기획서 문서에 특화된 청킹 전략을 도입한다.

### 1.2 목적

- 토큰 초과 오류 없이 대형 PRD/기획서 문서를 안정적으로 처리한다.
- PRD 문서의 구조적 특성(섹션 계층, 요구사항 번호 체계, 표, 목록)을 보존하는 청킹 전략을 제공한다.
- 4가지 청킹 전략(Fixed-size, Hierarchical Parent-Child, Semantic, Late Chunking)을 PRD 문서 유형에 맞게 선택적으로 적용할 수 있는 시스템을 구축한다.
- `/chunk` 커맨드를 PRD 전용 옵션(`--prd`)으로 확장하여 사용자 편의성을 높인다.

---

## 2. 요구사항 목록

### 기능 요구사항

**R1. 토큰 초과 방지 자동 청킹**
MD 파일 또는 PDF를 읽기 전에 토큰 수를 사전 추정하여, 설정된 임계값(기본값: 60,000 토큰)을 초과할 경우 자동으로 청킹 처리로 전환한다. 임계값은 실제 오류 발생 구간(90,000~150,000 토큰)보다 충분히 낮게 설정하여 안전 마진을 확보한다.

**R2. Fixed-size Chunking (기본 전략)**
고정 토큰 크기 기반 분할. PRD 문서 기본값을 현행 4,000 토큰에서 8,000 토큰으로 상향 조정하고, 오버랩을 400 토큰으로 확대한다. 섹션 경계(`# `, `## `, `### `)를 우선 분할점으로 사용하여 섹션 중간 절단을 최소화한다.

**R3. Hierarchical Parent-Child Chunking (PRD 전용 핵심 전략)**
PRD 문서의 계층 구조를 그대로 반영한 청킹 방식. 각 청크는 상위 섹션 제목(Parent)과 해당 소섹션 본문(Child)으로 구성된다. Child 청크는 항상 Parent 컨텍스트(섹션 경로)를 메타데이터로 포함한다.

```
예시 구조:
  Parent: "## 2. 요구사항 목록"
  Child1: "### 기능 요구사항 > R1~R5"
  Child2: "### 비기능 요구사항 > NR1~NR3"

  청크 메타데이터:
  {
    "path": ["PRD: 제목", "2. 요구사항 목록", "기능 요구사항"],
    "level": 3,
    "parent_summary": "요구사항 목록 섹션의 기능 요구사항 항목"
  }
```

**R4. Semantic Chunking (의미 단위 분할)**
요구사항 번호(R1, R2, NR1 등) 또는 의미론적 경계(빈 줄 2개 이상, 구분선 `---`)를 기준으로 분할한다. 표(markdown table)는 단일 청크로 유지하여 표 내용이 분리되지 않도록 보장한다. 목록(bulleted/numbered list)은 논리적 그룹 단위로 묶는다.

**R5. Late Chunking (지연 청킹)**
문서 전체를 임베딩 인코딩한 후 의미적 유사성이 변화하는 지점에서 청크를 분리한다. PRD 문서에서는 주제 전환점(배경 → 요구사항 → 기능범위 → 제약사항 → 성공기준) 감지에 활용한다. 실시간 처리보다 전처리(오프라인 분석) 단계에서 적용한다.

**R6. PRD 전용 `/chunk --prd` 옵션**
`/chunk` 커맨드에 `--prd` 플래그를 추가한다. 활성화 시 Hierarchical Parent-Child 전략을 기본으로 사용하고, 섹션 메타데이터를 JSON 출력에 포함한다.

```
/chunk <path> --prd                      # PRD 전용 계층형 청킹
/chunk <path> --prd --strategy semantic  # PRD + 의미 단위 분할
/chunk <path> --prd --strategy fixed     # PRD 메타데이터 + 고정 크기
/chunk <path> --prd --preview 3          # 처음 3개 청크 미리보기
```

**R7. MD 파일 직접 청킹 지원**
현재 PDF만 지원하는 `/chunk` 커맨드를 MD 파일(`.md`, `.markdown`)도 처리할 수 있도록 확장한다. MD 파일은 `pymupdf` 없이 순수 Python 텍스트 파싱으로 처리한다.

**R8. 청크 간 컨텍스트 연결 메타데이터**
각 청크에 이전/다음 청크 ID, 섹션 경로, 문서 전체 요약을 메타데이터로 포함하여 LLM이 전체 문서 맥락을 유지하며 각 청크를 처리할 수 있도록 한다.

**R9. 자동 전략 선택**
문서 유형 및 크기를 분석하여 최적 전략을 자동 추천한다.

```
  토큰 추정치 < 60,000   → 청킹 불필요 (전체 전송)
  60,000 ~ 100,000      → Fixed-size (8,000 토큰)
  PRD 구조 감지됨        → Hierarchical Parent-Child (우선)
  표/목록 집중 문서       → Semantic
  100,000 초과           → Late Chunking + Hierarchical 조합
```

### 비기능 요구사항

**NR1. 처리 성능**
100페이지 이하 PDF 또는 50,000단어 이하 MD 파일의 청킹 처리 시간은 30초 이내여야 한다. 100페이지 초과 문서는 백그라운드 실행으로 전환하며, 진행 상황을 5초 단위로 보고한다.

**NR2. 청크 품질**
단일 청크 내에서 표(markdown table) 또는 코드 블록(```코드```)이 분리되는 경우가 발생해서는 안 된다. 섹션 제목은 반드시 해당 섹션의 첫 번째 청크에 포함되어야 한다.

**NR3. 하위 호환성**
`--prd` 옵션 없이 기존 방식으로 호출하는 경우 현재 동작(4,000 토큰 / 200 오버랩 Fixed-size)이 변경 없이 유지되어야 한다.

---

## 3. 기능 범위

### In-Scope

- MD 파일 및 PDF 파일의 PRD 전용 청킹 처리
- 4가지 청킹 전략 구현 및 자동 선택 로직
- `/chunk --prd` 옵션 추가 및 기존 커맨드 하위 호환 유지
- 청크 메타데이터 포함(섹션 경로, 청크 ID, 이전/다음 링크)
- 토큰 사전 추정 및 자동 청킹 전환 임계값 설정
- PRD 구조 감지 로직(섹션 헤딩, 요구사항 번호 패턴)
- 처리 결과 JSON 출력 형식 확장

### Out-of-Scope

- Word(.docx), Excel(.xlsx) 등 비텍스트 형식 지원 (별도 PRD 필요)
- 벡터 DB 연동 또는 임베딩 저장소 통합
- 실시간 스트리밍 청킹 (API 응답을 실시간으로 청킹하는 방식)
- 다국어 전용 토크나이저 (tiktoken cl100k_base 사용 유지)
- 청크 결과의 자동 LLM 전송 및 응답 통합 (청킹 자체만 담당)
- GUI 인터페이스

---

## 4. 제약사항

**C1. 토큰 임계값 설정 근거**
Claude API의 실제 토큰 초과 오류는 90,000~150,000 토큰 구간에서 발생한다. 안전 마진(약 33%)을 적용하여 청킹 트리거 임계값을 60,000 토큰으로 설정한다. 이 값은 `lib/pdf_utils/config.py` 또는 환경변수(`CHUNK_TOKEN_THRESHOLD`)로 조정 가능해야 한다.

**C2. 의존성 제약**
신규 의존성 추가는 최소화한다. Late Chunking의 임베딩 계산에 `sentence-transformers` 라이브러리가 필요할 경우, 해당 전략은 optional 기능으로 분류하고 미설치 시 Hierarchical 전략으로 자동 폴백한다.

**C3. Windows 경로 호환**
모든 파일 경로 처리는 Windows(`C:\`) 및 Unix(`/`) 경로를 모두 지원한다. `pathlib.Path`를 사용하여 경로 구분자 차이를 추상화한다.

**C4. 기존 JSON 출력 형식 유지**
`--prd` 옵션 사용 시 기존 JSON 출력 필드(`source_file`, `total_pages`, `chunk_count`, `chunks` 배열)는 그대로 유지하고, PRD 전용 필드(`prd_mode`, `strategy`, `section_tree`)를 추가하는 방식으로 확장한다.

**C5. 메모리 제한**
대형 PDF(500+ 페이지) 처리 시 메모리 사용량이 2GB를 초과하지 않도록 스트리밍 파싱 방식을 사용한다.

---

## 5. 우선순위

| 요구사항 | 우선순위 | 이유 |
|---------|---------|------|
| R1. 토큰 초과 방지 자동 청킹 | P0 (필수) | 현재 발생 중인 오류의 직접적 해결 |
| R3. Hierarchical Parent-Child | P0 (필수) | PRD 구조 보존 핵심 전략 |
| R7. MD 파일 직접 청킹 지원 | P0 (필수) | 오류가 MD에서도 발생하므로 필수 |
| R2. Fixed-size 개선 (8,000/400) | P1 (고우선) | 즉시 적용 가능한 개선, 기존 호환 |
| R6. `/chunk --prd` 옵션 | P1 (고우선) | 사용자 인터페이스 진입점 |
| R8. 청크 간 컨텍스트 메타데이터 | P1 (고우선) | LLM 품질 향상에 직결 |
| R9. 자동 전략 선택 | P2 (중간) | 편의성. 수동 선택 먼저 지원 후 자동화 |
| R4. Semantic Chunking | P2 (중간) | 표/목록 많은 PRD에서 유용 |
| R5. Late Chunking | P3 (낮음) | 외부 의존성 필요, optional 구현 |
| NR1. 처리 성능 | P1 (고우선) | 30초 기준은 UX에 직접 영향 |
| NR2. 청크 품질 | P0 (필수) | 표/코드블록 분리 시 내용 손실 발생 |
| NR3. 하위 호환성 | P0 (필수) | 기존 사용자 워크플로우 보호 |

---

## 6. 성공 기준

**SC1. 토큰 초과 오류 0건**
대상 문서 유형(PRD, 기획서 MD/PDF)에서 토큰 초과 오류가 발생하지 않아야 한다. 기준: 10개 샘플 문서(50,000~200,000 토큰 규모) 처리 시 오류 0건.

**SC2. 섹션 경계 보존율 95% 이상**
Hierarchical 전략 적용 시, 생성된 청크 중 섹션 제목이 해당 청크의 첫 번째 라인에 포함된 비율이 95% 이상이어야 한다.

**SC3. 표/코드블록 무결성 100%**
생성된 모든 청크에서 markdown 표(`|---|`) 또는 코드 블록(` ``` `)이 분리된 사례가 0건이어야 한다.

**SC4. 처리 속도**
50페이지 이하 PDF 또는 30,000 단어 이하 MD: 10초 이내 완료.
100페이지 이하 PDF 또는 50,000 단어 이하 MD: 30초 이내 완료.

**SC5. 하위 호환성 검증**
기존 `/chunk <pdf>` 호출(--prd 없음) 시 출력 JSON 형식이 현행과 동일해야 한다. 기준: 회귀 테스트 10개 케이스 100% 통과.

**SC6. PRD 구조 자동 감지 정확도**
PRD 문서(섹션 헤딩 + 요구사항 번호 포함) 샘플 10개 중 9개 이상에서 Hierarchical 전략이 자동 선택되어야 한다.

---

## 부록 A. 4가지 청킹 전략 PRD 적용 시나리오

### A.1 Fixed-size — 단순 대용량 PRD

```
  적용 시나리오: 섹션이 매우 불균등하거나 구조화되지 않은 기획서
  PRD 예시: 레거시 텍스트 기획서, 구조 없이 작성된 요구사항 메모
  설정: 8,000 토큰 / 400 오버랩
  분할 기준: 섹션 경계 우선, 없으면 문단 경계, 없으면 고정 토큰
  한계: 요구사항 R3이 두 청크에 걸쳐 분리될 수 있음
```

### A.2 Hierarchical Parent-Child — 구조화된 PRD (핵심)

```
  적용 시나리오: 표준 PRD 형식 문서 (배경/요구사항/범위/제약/성공기준)
  PRD 예시: 본 문서와 같은 구조화된 PRD
  구조 맵:
    H1 (문서 제목) → Root
    H2 (섹션)     → Parent
    H3 (소섹션)   → Child
    H4+ (세부)    → Leaf

  청크 예시:
    Parent 청크: "## 2. 요구사항 목록" + 섹션 개요
    Child 청크:  "### 기능 요구사항 R1~R5" (Parent 경로 메타데이터 포함)

  장점: LLM이 "이 청크는 요구사항 목록 > 기능 요구사항" 임을 항상 인식
```

### A.3 Semantic — 표/목록 집중 PRD

```
  적용 시나리오: 우선순위 표, 비교 표, 기능 목록이 많은 PRD
  PRD 예시: 기능 비교 스펙 문서, 마이그레이션 체크리스트 PRD
  분할 기준:
    - 표(|---|) 단위: 표 전체를 하나의 청크로 보존
    - 요구사항 번호(R1., NR1.) 변경 지점
    - 빈 줄 2개 이상인 의미론적 경계
  장점: 표가 잘리지 않아 내용 손실 없음
```

### A.4 Late Chunking — 대형 통합 PRD

```
  적용 시나리오: 여러 서브시스템이 통합된 100,000 토큰 이상의 대형 PRD
  PRD 예시: 플랫폼 전체 사양서, 멀티 팀 PRD 통합본
  처리 방식:
    1. 전체 문서를 sentence-transformers로 임베딩
    2. 코사인 유사도 급변 지점 탐지 (주제 전환)
    3. 전환점 기준으로 청크 경계 설정
  장점: 인위적 경계 없이 의미 전환점에서 자연스럽게 분리
  주의: sentence-transformers 설치 필요 (optional 기능)
```

---

## 부록 B. 현행 vs 개선 후 비교

```
  +-------------------------+------------------+----------------------------+
  | 항목                    | 현행 (v1.x)      | 개선 후 (v2.0)             |
  +-------------------------+------------------+----------------------------+
  | 기본 청크 크기          | 4,000 토큰       | 8,000 토큰 (PRD 모드)      |
  | 오버랩                  | 200 토큰         | 400 토큰 (PRD 모드)        |
  | 지원 파일 형식          | PDF만            | PDF + MD                   |
  | 전략 수                 | 1 (Fixed-size)   | 4 (Fixed/Hier/Seman/Late)  |
  | 섹션 메타데이터         | 없음             | 섹션 경로 포함              |
  | 자동 임계값 감지        | 없음             | 60,000 토큰 자동 전환       |
  | 표 보존                 | 보장 안됨        | 100% 보장 (Semantic 전략)   |
  | PRD 전용 옵션           | 없음             | --prd 플래그                |
  +-------------------------+------------------+----------------------------+
```

---

## Changelog

- v1.0.0 (2026-02-19): 최초 작성 — PRD/기획서 전용 청킹 전략 PRD 초안
