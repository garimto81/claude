# PRD-0001: 포커 핸드 자동 캡처 및 분류 시스템

## 문서 정보

| 항목 | 내용 |
|------|------|
| **PRD ID** | PRD-0001 |
| **제목** | 포커 피처 테이블 핸드 자동 캡처 및 분류 시스템 |
| **버전** | 2.0 |
| **작성일** | 2025-12-23 |
| **수정일** | 2025-12-24 |
| **상태** | In Progress |
| **일정** | 2026-01-02 ~ 2026-03-02 (9주) |

### 관련 문서

| PRD | 제목 | 설명 |
|-----|------|------|
| [PRD-0002](./FT-0002-primary-gfx-rfid.md) | Primary Layer - GFX RFID | PokerGFX JSON API 기술 상세 |
| [PRD-0003](./FT-0003-secondary-gemini-live.md) | Secondary Layer - Gemini Live | AI 비디오 분석 기술 상세 |
| [PRD-0004](./FT-0004-fusion-engine.md) | Fusion Engine | 2중 검증 로직 기술 상세 |

---

## 1. 개요

### 1.1 배경

PokerGFX.io 솔루션을 사용하는 포커 프로덕션 환경에서 여러 대의 피처 테이블(3-5대)에서 발생하는 핸드를 수동으로 모니터링하고 하이라이트를 선별하고 있습니다. 이를 효율적으로 소수의 인원이 관리할 수 있는 시스템으로 구축합니다.

#### 현재 인력 구조 (5명)

| 역할 | 인원 | 업무 |
|------|------|------|
| 시트 관리 | 1명 | 플레이어 시트 배정 및 관리 |
| 전체 모니터링 | 1명 | 모든 테이블 상황 모니터링 |
| 피처 테이블 A | 1명 | 테이블 A 핸드 캡처 및 분류 |
| 피처 테이블 B | 1명 | 테이블 B 핸드 캡처 및 분류 |
| 피처 테이블 C | 1명 | 테이블 C 핸드 캡처 및 분류 |

#### 목표 인력 구조 (1명 + AI)

| 역할 | 담당 | 비고 |
|------|------|------|
| 시트 관리 | 1명 | 유지 |
| 전체 모니터링 | **AI** | 자동화 |
| 피처 테이블 A/B/C | **AI** | 자동화 |

**인력 절감 효과: 80% (5명 → 1명)**

### 1.2 목표

1. **핸드 시작/종료 자동 감지**: 각 테이블에서 핸드의 시작점과 종료점을 정확하게 포착
2. **핸드 등급 자동 분류**: 족보(Royal Flush ~ High Card)에 따른 자동 분류
3. **2중 안정성 확보**: Primary(PokerGFX JSON API) + Secondary(AI Video) 이중화 아키텍처
4. **실시간 오버레이**: 방송용 오버레이 데이터 제공

### 1.3 성공 지표

| 지표 | 목표값 |
|------|--------|
| 핸드 감지 정확도 | > 99% (Primary 사용 시) |
| 핸드 분류 정확도 | 100% (phevaluator 기반) |
| 시스템 가용성 | > 99.9% (이중화 적용) |
| 핸드 감지 지연시간 | < 2초 |

---

## 2. 사용자 환경

### 2.1 현재 인프라

| 항목 | 현황 |
|------|------|
| **PokerGFX 라이선스** | 엔터프라이즈/프로 |
| **피처 테이블 수** | 3-5대 동시 운영 |
| **영상 워크플로우** | 실시간 후반 편집 → 방송 송출 |

### 2.2 활용 목적

피처 테이블을 **핸드 단위로 분리/캡처** → **등급 표기** → **종합 편집팀에 핸드 소스 제공**

| 단계 | 내용 |
|------|------|
| 1. 핸드 분리 | 피처 테이블에서 핸드 단위로 영상 분리 |
| 2. 등급 표기 | 각 핸드에 등급 및 하이라이트 태그 부착 |
| 3. 소스 제공 | 실제 송출에 필요한 핸드 선별 → 종합 편집팀 전달 |

**구체적 활용**:
- 실시간 스트리밍 오버레이 (핸드 등급 표시)
- 하이라이트 클립 자동 마킹 (후반 편집용)

### 2.3 3단계 핸드 분류 프로세스

| 단계 | 소스 | 역할 |
|------|------|------|
| **1차** | GFX RFID JSON | RFID 기반 정확한 카드 데이터로 핸드 분류 |
| **2차** | Gemini Live API | AI 비디오 분석으로 핸드 분류 (백업) |
| **3차** | Fusion AI | 1차+2차 결과 분석 → 핸드 등급 + 편집 시작점 도출 |

---

## 3. 기술 아키텍처

### 3.1 2중 안정성 아키텍처

두 개의 필터를 **완전히 분리**하여 독립적으로 분석합니다.

| Filter | 소스 | 역할 | 협의 담당 |
|--------|------|------|----------|
| **Filter 1** | GFX 분석 | PokerGFX RFID, JSON Hand Events (99.9% 정확도) | **기술팀** |
| **Filter 2** | Live API 분석 | Gemini Live API, AI Video Inference (Real-time) | **ATI 팀** |

> 두 필터는 완전 분리되어 독립적으로 동작하며, Fusion Engine에서 조합하여 추론합니다.
>
> **협의 체계**: GFX 관련 사항은 **기술팀**, Live API 관련 사항은 **ATI 팀**과 협의하여 처리합니다.

![2중 안정성 아키텍처](../../docs/images/architecture.png)

### 3.2 Layer 1: Primary (PokerGFX JSON API)

| 항목 | 값 |
|------|-----|
| **신뢰도** | 99.9% (RFID 기반 정확한 데이터) |
| **지연시간** | < 100ms |
| **용도** | 핸드 데이터의 정확한 소스 |

PokerGFX RFID 시스템에서 JSON 데이터를 수신하여 phevaluator 라이브러리로 핸드를 분류합니다.

> **기술 상세**: [PRD-0002: Primary Layer - GFX RFID](./FT-0002-primary-gfx-rfid.md)

### 3.3 Layer 2: Secondary (AI Video 분석)

| 항목 | 값 |
|------|-----|
| **신뢰도** | 85-95% (조명, 각도에 따라 변동) |
| **지연시간** | 1-3초 (1 FPS 샘플링) |
| **용도** | Primary 백업 + 맥락적 이벤트 감지 |
| **협의 담당** | **ATI 팀** |

Gemini Live API를 통해 비디오 스트림을 실시간 분석하여 핸드를 감지합니다.

![Secondary Layer - Gemini Live API](../../docs/images/live-api-architecture.png)

> **기술 상세**: [PRD-0003: Secondary Layer - Gemini Live API](./FT-0003-secondary-gemini-live.md)

### 3.4 Fusion Engine: 2중 검증 로직

Primary와 Secondary 중 **하나를 선택하는 것이 아니라**, 두 검증 로직을 **조합**하여 하나의 완성된 데이터를 토대로 추론합니다.

| 단계 | 처리 | 설명 |
|------|------|------|
| 1 | **교차 검증** | GFX와 Live API 결과 일치 여부 확인 |
| 2 | **상호 보완** | 누락된 데이터를 상대 소스로 채움 |
| 3 | **신뢰도 산출** | 최종 확률 계산 |

**4가지 케이스 분기**:

| 케이스 | Primary | Secondary | 처리 |
|:------:|:-------:|:---------:|------|
| 1 | ✅ | ✅ 일치 | Primary 사용 (validated) |
| 2 | ✅ | ✅ 불일치 | Primary 사용 (review 플래그) |
| 3 | ❌ | ✅ (≥0.8) | Secondary fallback |
| 4 | ❌ | ❌ | Manual 필요 |

> **기술 상세**: [PRD-0004: Fusion Engine](./FT-0004-fusion-engine.md)

![Fusion Engine 2중 검증 로직](../../docs/images/fusion-engine.png)

---

## 4. 기능 요구사항

### 4.1 핵심 기능

| ID | 기능 | 우선순위 | 설명 |
|----|------|----------|------|
| F-001 | 핸드 시작 감지 | P0 | 새 핸드 딜링 시점 자동 감지 |
| F-002 | 핸드 종료 감지 | P0 | 팟 푸시, 카드 머크 시점 감지 |
| F-003 | 핸드 등급 분류 | P0 | 족보 자동 분류 (10단계) |
| F-004 | 멀티테이블 동시 처리 | P0 | 3-5대 테이블 병렬 처리 |
| F-005 | 2중 검증 | P1 | Primary-Secondary 교차 검증 |
| F-006 | 실시간 오버레이 | P1 | WebSocket 기반 방송 오버레이 |
| F-007 | 클립 마커 생성 | P2 | EDL/XML 편집점 자동 생성 |
| F-008 | 모니터링 대시보드 | P2 | 시스템 상태 실시간 모니터링 |
| F-009 | 플레이어 성향 분석 | P1 | VPIP/PFR 기반 플레이어 유형 분류 |
| F-010 | 데이터 시각화 | P2 | Metabase 대시보드 연동 |

### 4.2 족보 등급표

| 등급 | 핸드 | 방송 가능 |
|:----:|------|:--------:|
| 1 | Royal Flush | ✅ |
| 2 | Straight Flush | ✅ |
| 3 | Four of a Kind | ✅ |
| 4 | Full House | ✅ |
| 5 | Flush | ✅ |
| 6 | Straight | ✅ |
| 7 | Three of a Kind | ✅ |
| 8 | Two Pair | ❌ |
| 9 | One Pair | ❌ |
| 10 | High Card | ❌ |

> **7번(Triple) 이상은 방송 가능**

### 4.3 핸드 등급 분류 기준

**조건** (2개 이상 충족 시 등급 확보):

| 조건 | 설명 | 기준 |
|------|------|------|
| **1. 프리미엄 핸드** | 플레이어 소유 핸드가 프리미엄 | 등급 1-4 (Royal ~ Full House) |
| **2. 플레이 시간** | 핸드 플레이 시간이 긴 경우 | 세션 평균 × 1.5배 이상 |
| **3. 보드 조합** | 보드+핸드 조합이 Three of a Kind 이상 | 등급 7+ (7번부터 체크) |

**결과**:

| 결과 | 조건 | 처리 |
|------|------|------|
| **등급 확보** | 2개 이상 충족 | 종합 편집팀에 소스 제공 |
| **스킵** | 1개 이하 충족 | 아카이브만 |

> **2개 이상 조건 충족 → 방송 소스 제공**

![핸드 등급 분류 기준](../../docs/images/hand-grading.png)

### 4.4 편집점 시작점 추론 방법

기존 방송 분석을 통한 패턴 학습으로 편집 시작점 자동 추론

| 방법 | 설명 |
|------|------|
| **패턴 학습** | 기존 방송 영상의 편집점 분석 |
| **이벤트 감지** | 딜러 액션, 팟 푸시, 쇼다운 등 주요 이벤트 |
| **시간 기반** | 핸드 시작 N초 전부터 캡처 시작 |

### 4.5 플레이어 성향 분석 (F-009)

> 상세: [PRD-0002: 플레이어 성향 분석](./FT-0002-primary-gfx-rfid.md#7-플레이어-성향-분석)

PokerGFX JSON에서 제공하는 플레이어 통계(VPIP, PFR, AF, WTSD)를 활용하여 자동으로 플레이어 유형을 분류합니다.

**플레이어 유형 분류**:

| 유형 | VPIP | PFR | 방송 타겟 | 설명 |
|------|:----:|:---:|:--------:|------|
| **Fish** | >35% | <15% | ✅ | 콜링 스테이션, 드라마틱한 상황 유발 |
| **Maniac** | >40% | >30% | ✅ | 고변동성, 빅팟 가능성 |
| **LAG** | 25-35% | 20-30% | ⚠️ | 넓은 레인지, 액션 많음 |
| **TAG** | 15-25% | 15-20% | ❌ | 타이트-어그레시브, 예측 가능 |
| **Nit** | <15% | <10% | ❌ | 프리미엄만 플레이 |

**활용 목적**:
- 방송 포커스 대상 자동 추천
- 빅팟 가능성 사전 예측
- 하이라이트 클립 우선순위 결정

### 4.6 데이터 시각화 (F-010)

> 상세: [PRD-0005: Metabase 대시보드](./FT-0005-integrated-db-subtitle-system.md#b-metabase-시각화-대시보드)

Metabase를 활용한 실시간 포커 분석 대시보드:

| 패널 | 차트 타입 | 설명 |
|------|----------|------|
| **Cumulative Winnings** | Line Chart | 플레이어별 누적 수익 추이 |
| **VPIP/PFR Comparison** | Grouped Bar | Top 5 플레이어 성향 비교 |
| **Pot Size Distribution** | Histogram | 팟 사이즈 분포 |
| **Player Type Breakdown** | Pie Chart | Fish/TAG/LAG 비율 |

---

## 5. 기술 스택

### 5.1 컴포넌트별 기술

| Layer | 컴포넌트 | 기술 | 비고 |
|-------|----------|------|------|
| Primary | PokerGFX JSON | 기존 라이선스 | API 문서 필요 |
| Primary | Hand Evaluator | phevaluator (Python) | 무료, 최고 성능 |
| Secondary | AI Video | Gemini 2.5 Flash Live API | WebSocket |
| Secondary | Video Capture | OpenCV + FFmpeg | RTSP/NDI 입력 |
| Fusion | Engine | Python 3.11+ | 비동기 처리 |
| Output | Overlay | WebSocket + HTML | 브라우저 소스 |
| Output | Markers | EDL/XML | Premiere/DaVinci 호환 |
| Infra | Server | 기존 장비 활용 | 별도 GPU 불필요 |

### 5.2 예상 비용

| 항목 | 초기 비용 | 월 운영 비용 |
|------|----------|-------------|
| PokerGFX 라이선스 | (기존) | - |
| Gemini API | - | $500~1,000 |
| 서버 | 기존 장비 활용 | - |
| **합계** | - | **$500~1,000** |

---

## 6. 구현 로드맵

> **기준일**: 2026-01-02 | **총 기간**: 9주 | **완료 예정**: 2026-03-02

### 일정 요약

| Phase | 기간 | 시작일 | 종료일 | 주요 작업 |
|:-----:|:----:|:------:|:------:|----------|
| **0** | Week 0 | 01/02 | 01/05 | 사전 준비 (API 확보, 인프라 확인) |
| **1** | Week 1-2 | 01/06 | 01/19 | Primary Layer 구축 (PokerGFX JSON) |
| **2** | Week 3-4 | 01/20 | 02/02 | Secondary Layer 구축 (Gemini AI) |
| **3** | Week 5 | 02/03 | 02/09 | Fusion Engine 개발 |
| **4** | Week 6-7 | 02/10 | 02/23 | 멀티테이블 확장 |
| **5** | Week 8 | 02/24 | 03/02 | 프로덕션 배포 |

### 마일스톤

| 마일스톤 | 목표일 | 성공 기준 |
|----------|:------:|----------|
| **M1**: API 확보 완료 | 01/05 | PokerGFX API + Gemini API 접근 가능 |
| **M2**: Primary MVP | 01/19 | 단일 테이블 핸드 감지 정확도 >99% |
| **M3**: Secondary MVP | 02/02 | AI 비디오 분석 정확도 >85% |
| **M4**: Fusion 완성 | 02/09 | 교차 검증 로직 동작 |
| **M5**: 프로덕션 Ready | 03/02 | 전체 파이프라인 가용성 >99.9% |

---

### Phase 0: 사전 준비 (01/02 ~ 01/05)

| 날짜 | 작업 | 상태 |
|:----:|------|:----:|
| 01/02-03 | PokerGFX 기술지원팀 연락, JSON API 문서 요청 | [ ] |
| 01/04 | Gemini API 키 발급, Live API 접근 권한 확인 | [ ] |
| 01/05 | 인프라 확인 (RTSP/NDI, 네트워크 대역폭) | [ ] |

### Phase 1: Primary 구축 (01/06 ~ 01/19)

**Week 1 (01/06 ~ 01/12)**
- [ ] PokerGFX API 문서 확보
- [ ] JSON 스키마 정의
- [ ] 핸드 이벤트 파서 구현

**Week 2 (01/13 ~ 01/19)**
- [ ] phevaluator 기반 핸드 분류 엔진
- [ ] 카드 문자열 변환기
- [ ] 단일 테이블 테스트 (정확도 >99%, 지연 <100ms)

### Phase 2: Secondary 구축 (01/20 ~ 02/02)

**Week 3 (01/20 ~ 01/26)**
- [ ] Gemini Live API 계정 설정
- [ ] OpenCV RTSP 비디오 캡처 파이프라인
- [ ] WebSocket 연결 구현

**Week 4 (01/27 ~ 02/02)**
- [ ] 포커 컨텍스트 프롬프트 튜닝
- [ ] 단일 테이블 AI 분석 테스트
- [ ] 신뢰도 임계값 조정 (>0.8)

### Phase 3: Fusion 통합 (02/03 ~ 02/09)

- [ ] Fusion Engine 개발 (02/03-05)
- [ ] 4가지 케이스 분기 로직 구현 (02/06-07)
- [ ] 모니터링 대시보드 구축 (02/08-09)

### Phase 4: 멀티테이블 확장 (02/10 ~ 02/23)

**Week 6 (02/10 ~ 02/16)**
- [ ] 3-5대 테이블 동시 처리
- [ ] 부하 테스트 및 최적화

**Week 7 (02/17 ~ 02/23)**
- [ ] 실시간 오버레이 개발
- [ ] EDL/XML 클립 마커 생성

### Phase 5: 프로덕션 배포 (02/24 ~ 03/02)

- [ ] 실제 방송 환경 테스트 (02/24-26)
- [ ] 장애 복구 테스트 (02/27-28)
- [ ] 운영 매뉴얼 작성 (03/01-02)
- [ ] 후반 편집 워크플로우 연동

---

## 7. 위험 요소 및 대응

| 위험 | 영향 | 대응 방안 |
|------|------|----------|
| PokerGFX API 미제공 | 높음 | AI Video를 Primary로 승격, YOLO 커스텀 모델 |
| Gemini API 비용 초과 | 중간 | 프레임 레이트 조정 (0.5 FPS), 배치 처리 |
| 네트워크 지연 | 중간 | 로컬 버퍼링, 오프라인 모드 |
| AI 오탐지 | 낮음 | 신뢰도 임계값 조정, 수동 검토 플래그 |

---

## 8. 다음 단계 (액션 아이템)

### 즉시 필요
1. **PokerGFX 기술지원 연락** (담당: **기술팀**)
   - JSON API 문서 요청
   - 멀티테이블 이벤트 스트림 구조 확인
   - GFX 분석 관련 기술 협의

2. **Gemini API 키 발급** (담당: **ATI 팀**)
   - Google AI Studio 또는 Vertex AI
   - Live API 접근 권한 확인
   - AI Video 분석 관련 협의

### 기술 검증
3. **PoC 개발**
   - 단일 테이블 Primary 파이프라인
   - Gemini Live API 연동 테스트

4. **비디오 인프라 확인**
   - 각 테이블 카메라의 RTSP/NDI 출력 가능 여부
   - 네트워크 대역폭 (테이블당 5-10 Mbps)

---

## 9. 트러블슈팅

### 9.1 Docker 네트워크 문제 (Synology NAS)

#### 증상
`poker-capture` 컨테이너가 `poker-db`에 연결 실패

```
connection refused: db:5432
could not translate host name "db" to address
```

#### 원인
Synology NAS Docker의 bridge 네트워크 제한:

| 시도 | DB_HOST 설정 | 결과 |
|------|--------------|------|
| 1 | `db` (서비스명) | DNS 해석 안 됨 |
| 2 | `poker-db` (컨테이너명) | DNS 해석 안 됨 |
| 3 | `10.10.100.122` (NAS IP) | 컨테이너→호스트 접근 불가 |
| 4 | `host.docker.internal` | Synology 미지원 |

```
┌─────────────────────────────────────────────────┐
│  NAS Host (10.10.100.122)                       │
│   ┌─────────────────────────────────────────┐   │
│   │  Docker bridge network                  │   │
│   │  poker-db ←──❌──→ poker-capture        │   │
│   │  (172.17.0.2)      (172.17.0.3)         │   │
│   └─────────────────────────────────────────┘   │
│             ↕ 격리된 벽                          │
│   Host port: 5432 ─────────────────────────────  │
└─────────────────────────────────────────────────┘
```

#### 해결책
`poker-capture`에 `network_mode: host` 적용:

```yaml
poker-capture:
  network_mode: host
  environment:
    - DB_HOST=127.0.0.1  # localhost로 직접 접근
    - DB_PORT=5432
```

**장점**: NAS 호스트 네트워크 직접 사용 → 127.0.0.1:5432로 DB 접근 가능
**단점**: 컨테이너 포트 격리 불가 (호스트 포트 직접 사용)

---

## 부록

### A. 참조 자료

- [PokerGFX 공식](https://www.pokergfx.io/)
- [Gemini Live API](https://ai.google.dev/gemini-api/docs/live)
- [Gemini 3 Flash](https://blog.google/products/gemini/gemini-3-flash/)
- [phevaluator](https://github.com/HenryRLee/PokerHandEvaluator)

### B. 용어 정의

| 용어 | 설명 |
|------|------|
| RFID | Radio-Frequency Identification, 카드 인식 기술 |
| Hand | 포커에서 딜링부터 팟 푸시까지의 한 라운드 |
| Showdown | 남은 플레이어들이 카드를 공개하는 시점 |
| Hole Cards | 플레이어에게만 보이는 두 장의 카드 |
| Community Cards | 테이블 중앙에 공개되는 5장의 카드 |
| EDL | Edit Decision List, 비선형 편집 마커 형식 |

