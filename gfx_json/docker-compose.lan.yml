# GFX Sync Agent - LAN 전용 구성 (Supabase Self-Hosted)
# 사용: docker compose -f docker-compose.lan.yml up -d

version: "3.8"

services:
  # ============================================================
  # Sync Agent - LAN Supabase Self-Hosted 연결
  # ============================================================
  sync-agent:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: gfx-sync-agent
    restart: unless-stopped
    # LAN 환경: 내부 DNS 사용
    dns:
      - ${LAN_DNS:-192.168.1.1}
    volumes:
      # NAS 볼륨 마운트 (읽기 전용)
      - ${NAS_MOUNT_PATH}:/app/data:ro
      # 오프라인 큐 DB (영속성)
      - sync_queue:/app/queue
    environment:
      # === LAN Supabase Self-Hosted ===
      # 예: http://192.168.1.100:8000
      GFX_SYNC_SUPABASE_URL: ${SUPABASE_URL}
      GFX_SYNC_SUPABASE_SECRET_KEY: ${SUPABASE_SECRET_KEY}
      # === NAS 경로 ===
      GFX_SYNC_NAS_BASE_PATH: /app/data
      # === 폴링 설정 ===
      GFX_SYNC_POLL_INTERVAL: ${POLL_INTERVAL:-2.0}
      # === 배치 설정 ===
      GFX_SYNC_BATCH_SIZE: ${BATCH_SIZE:-500}
      GFX_SYNC_FLUSH_INTERVAL: ${FLUSH_INTERVAL:-5.0}
      # === 헬스체크 ===
      GFX_SYNC_HEALTH_PORT: "8080"
      GFX_SYNC_HEALTH_ENABLED: "true"
      # === 로그 ===
      GFX_SYNC_LOG_LEVEL: ${LOG_LEVEL:-INFO}
    ports:
      - "8081:8080"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8080/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# ============================================================
# Volumes
# ============================================================
volumes:
  sync_queue:
    name: gfx-sync-queue
