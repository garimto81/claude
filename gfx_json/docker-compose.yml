# GFX Sync System - NAS 중앙 관리
# 사용: docker-compose up -d

version: "3.8"

services:
  # ============================================================
  # Sync Agent - NAS 파일 감시 및 Supabase 동기화
  # ============================================================
  sync-agent:
    build:
      context: .
      dockerfile: Dockerfile.agent
    container_name: gfx-sync-agent
    restart: unless-stopped
    volumes:
      # NAS SMB 공유 폴더 마운트 (읽기 전용)
      # 호스트에서 먼저 SMB 마운트 필요:
      # mount -t cifs //NAS_IP/gfx_data /mnt/nas/gfx_data -o username=xxx,password=xxx
      - ${NAS_MOUNT_PATH:-/mnt/nas/gfx_data}:/app/data:ro
      # 로컬 큐 DB (영속성 - 재시작 시에도 유지)
      - sync_queue:/app/queue
    environment:
      - GFX_SYNC_NAS_BASE_PATH=/app/data
      - GFX_SYNC_SUPABASE_URL=${SUPABASE_URL}
      - GFX_SYNC_SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}
      - GFX_SYNC_POLL_INTERVAL=${POLL_INTERVAL:-2.0}
      - GFX_SYNC_BATCH_SIZE=${BATCH_SIZE:-500}
      - GFX_SYNC_FLUSH_INTERVAL=${FLUSH_INTERVAL:-5.0}
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================
  # Dashboard - Next.js 웹 대시보드
  # ============================================================
  dashboard:
    build:
      context: ./dashboard
      dockerfile: Dockerfile
    container_name: gfx-dashboard
    restart: unless-stopped
    ports:
      - "${DASHBOARD_PORT:-3000}:3000"
    environment:
      - NEXT_PUBLIC_SUPABASE_URL=${SUPABASE_URL}
      - NEXT_PUBLIC_SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
    depends_on:
      - sync-agent
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# ============================================================
# Volumes
# ============================================================
volumes:
  sync_queue:
    name: gfx-sync-queue
